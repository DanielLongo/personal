<!DOCTYPE html>
<html lang="en">
  <head>
    

<title>I thought it’d be a good idea to establish scopes at parse time | R. Miles McCain</title>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="Over the past week or so, I’ve been working on building my own simple interpreted programming language. My goal is to learn about language design, Lisp, and&hellip;" />
<meta property="og:description" content="Over the past week or so, I’ve been working on building my own simple interpreted programming language. My goal is to learn about language design, Lisp, and&hellip;" />
<meta property="og:site_name" content="R. Miles McCain" />
<meta property="og:type" content="website" />
<meta property="og:title" content="I thought it’d be a good idea to establish scopes at parse time | R. Miles McCain" />
<meta property="og:url" content="https://miles.land/errata/parse-time-scopes/" />
<link rel="canonical" href="https://miles.land/errata/parse-time-scopes/" />


<link rel='icon' type='image/png' href='https://miles.land/images/dithered_rounded_avatar.42de80a89933dfcd1c144a220041d743894ca5e42798424b32b5a01aa5b559d9.png' />

<link rel="stylesheet" href="https://miles.land/styles/base.min.8ad766a7551bd54e8af858a2c8826fdb86d6c923e759fb921cb0be3d7d1f2cee.css" />

<script async defer src="https://miles.land/scripts/base.min.ea8660a97fa2d59a6c39204cb0a7a37866134cb8588ce0d888e773a69b689da9.js"></script>
  </head>
  
  <body class="bg-neutral-000">
    <section class="max-w-4xl mx-auto p-4 relative min-h-screen">
      <div class="md:flex justify-center">
        <div class="md:w-8/12">
          
<nav class="mb-6 md:my-6 md:flex md:justify-between">
  <div>
    <h4>
      <a class="heading text-sm" style="border-bottom: none;"
      href="/">R. Miles McCain</a>
    </h4>
  </div>
  <div class="md:text-right">
    <ul class="-ml-2 md:ml-0">
      
      <li class="portal text-sm ">
        <a href="/portfolio/">
          
          <span>Portfolio</span>
          
        </a>
      </li>
      
      <li class="portal text-sm ">
        <a href="/micros/">
          
          <span>Micros</span>
          
        </a>
      </li>
      
      <li class="portal text-sm  ~urge active ">
        <a href="/errata/">
          
          <span>Errata</span>
          
        </a>
      </li>
      
      <li class="portal text-sm ">
        <a href="/cool/">
          
          <span>Cool</span>
          
        </a>
      </li>
      
      <li class="portal text-sm ">
        <a href="/posts/">
          
          <span>Posts</span>
          
        </a>
      </li>
      
      <li class="portal text-sm ">
        <a href="/letter/">
          
          <span>Letter</span>
          
        </a>
      </li>
      
    </ul>
  </div>
</nav>
          
          <div class="my-12">
            
<section>
    <div>
        
            
            <h3 class="inline heading font-bold md:text-4xl">
                I thought it’d be a good idea to establish scopes at parse time
                
            </h3>
            <h3 class="inline heading font-bold md:text-4xl text-neutral-500">
                
                <br>
                
            </h3>
            
    </div>
    <div class="mt-4">
        
        <span class="chip ~neutral !low -ml-2 mb-2">
            Jul 23, 2020
        </span>
        
        
        
        <a class="chip ~neutral !normal mb-2 mr-2" href="https://miles.land/tags/technical/">technical</a>
        
        
        
        <a class="chip ~neutral !normal mb-2 mr-2" href="https://miles.land/tags/turtle/">turtle</a>
        
        
        
        
    </div>
</section>

          </div>
        </div>
      </div>
      <div class="md:flex">
        <aside class="md:w-2/12">

        </aside>
        <div class="md:w-8/12">
          
<main>
  <section class="content">
    <p>Over the past week or so, I’ve been working on building my own simple interpreted programming language. My goal is to learn about language design, Lisp, and systems programming—all while building a language that is fun to use (and maybe, just maybe, one day I&rsquo;ll find it useful for something).</p>
<p>Even though the project has gone well so far (mostly thanks to the safety guarantees of the Rust programming language), I also made a <em>lot</em> of mistakes as I implemented the first version of the interpreter, and I&rsquo;m sure I&rsquo;ll make many more over the course of the project.</p>
<p>I’ll write more about the process of building the language in a future series of posts, but thought I’d dedicate an errata post to one mistake I made in particular: trying to establish scopes at parse time.</p>
<blockquote>
<p>Note: this post is heavy on technical details, but completely devoid of code samples. That&rsquo;s because I don&rsquo;t want this post to be about syntax. Hopefully the explanation below isn&rsquo;t hopelessly abstract!</p>
</blockquote>
<h3 id="how-scopes-are-supposed-to-work">How scopes are <em>supposed</em> to work</h3>
<p>When you refer to a variable (identifier), I want the interpreter to first search the local scope for a value—for example, the current function invocation. Then, if it doesn’t find a value, I want it to search the (lexical) parent scope, and so on until eventually it reaches the root (lexical) scope.</p>
<p>If you call a function with arguments, for example, those arguments’ values should be bound in the scope of the function invocation—<em>not</em> in the scope of the calling function. That is to say that a function shouldn’t affect the scope where it’s called.</p>
<h3 id="how-scopes-actually-ended-up-working">How scopes <em>actually</em> ended up working</h3>
<p>For some reason, I thought it would be a good idea to calculate scopes at parse time, so the scope tree roughly matched the parse tree. (This is a <em>very</em> naive way to implement lexical scoping, as I would soon learn.)</p>
<p>At first, this worked well! Functions weren’t affecting the scopes of where they were called from. But oh no — they <em>were</em> affecting the scope of where they were defined in ways they weren’t supposed to. For example, each time a function was called, it would reuse its old scope. This wasn&rsquo;t usually an issue, as my code was simple and single threaded, but it made recursion and multithreading nearly impossible.</p>
<h3 id="how-scopes-work-now">How scopes work now</h3>
<p>I’ll save this for a future post, as I’m still figuring it out. Scopes are no longer computed at parse time, but instead created during evaluation. Functions, when they are defined, internally store a reference to <em>their</em> parent scope so that lexical scoping works as expected (mostly for imports).</p>
<p>For now, it works. I still haven’t figured out a good namespace/module system, though, so everything is in flux until then&hellip;</p>

  </section>
</main>


          <hr class="sep h-16">
          <footer>
            <footer class="family-secondary support content">
  <p class="pb-2">
    Hi! If you made it this far, maybe you want to stay in touch. You can follow me on <a href="https://twitter.com/milesmccain">Twitter</a>, subscribe via <a href="/index.xml">Atom/RSS</a>, or sign up for my <a href="/letter/">infrequent email letter</a>.
  </p>
  <p class="pb-8">
    &copy; R. Miles McCain 2020.
    Content is licensed <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a>, a Free Culture License.
    The <a href="https://github.com/milesmcc/personal">source code</a> is available under <a href="https://github.com/milesmcc/personal/blob/master/LICENSE">GPLv3</a>.
    This site collects (minimal) user analytics using <a href="https://github.com/milesmcc/shynet">Shynet</a>.
    </p>
</footer>
          </footer>
        </div>
        <aside class="md:w-2/12 pl-8 self-start sticky-top hidden md:block text-xs">
          
        </aside>
      </div>
    </section>
    <noscript><img src="https://shynet.rmrm.io/ingress/aa93dbb3-7d36-4de1-8642-5074c7e33c92/pixel.gif"></noscript> <script src="https://shynet.rmrm.io/ingress/aa93dbb3-7d36-4de1-8642-5074c7e33c92/script.js"></script>
  </body>
  
</html>